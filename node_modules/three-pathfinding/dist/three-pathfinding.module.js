import{BufferAttribute as t,BufferGeometry as e,Vector3 as r,Plane as n,Triangle as o,Color as i,Line as s,Mesh as a,SphereBufferGeometry as u,MeshBasicMaterial as h,BoxBufferGeometry as c,Object3D as l,LineBasicMaterial as p}from"three";function f(t,e){return(f=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function d(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function v(t,e){var r;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return d(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?d(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=t[Symbol.iterator]()).next.bind(r)}var g,b=function(){function r(){}return r.roundNumber=function(t,e){var r=Math.pow(10,e);return Math.round(t*r)/r},r.sample=function(t){return t[Math.floor(Math.random()*t.length)]},r.distanceToSquared=function(t,e){var r=t.x-e.x,n=t.y-e.y,o=t.z-e.z;return r*r+n*n+o*o},r.isPointInPoly=function(t,e){for(var r=!1,n=-1,o=t.length,i=o-1;++n<o;i=n)(t[n].z<=e.z&&e.z<t[i].z||t[i].z<=e.z&&e.z<t[n].z)&&e.x<(t[i].x-t[n].x)*(e.z-t[n].z)/(t[i].z-t[n].z)+t[n].x&&(r=!r);return r},r.isVectorInPolygon=function(t,e,r){var n=1e5,o=-1e5,i=[];return e.vertexIds.forEach(function(t){n=Math.min(r[t].y,n),o=Math.max(r[t].y,o),i.push(r[t])}),!!(t.y<o+.5&&t.y>n-.5&&this.isPointInPoly(i,t))},r.triarea2=function(t,e,r){return(r.x-t.x)*(e.z-t.z)-(e.x-t.x)*(r.z-t.z)},r.vequal=function(t,e){return this.distanceToSquared(t,e)<1e-5},r.mergeVertices=function(r,n){void 0===n&&(n=1e-4),n=Math.max(n,Number.EPSILON);for(var o={},i=r.getIndex(),s=r.getAttribute("position"),a=i?i.count:s.count,u=0,h=[],c=[],l=Math.log10(1/n),p=Math.pow(10,l),f=0;f<a;f++){var d=i?i.getX(f):f,v="";v+=~~(s.getX(d)*p)+",",v+=~~(s.getY(d)*p)+",",(v+=~~(s.getZ(d)*p)+",")in o?h.push(o[v]):(c.push(s.getX(d)),c.push(s.getY(d)),c.push(s.getZ(d)),o[v]=u,h.push(u),u++)}var g=new t(new Float32Array(c),s.itemSize,s.normalized),b=new e;return b.setAttribute("position",g),b.setIndex(h),b},r}(),y=function(){function t(t){this.content=[],this.scoreFunction=t}var e=t.prototype;return e.push=function(t){this.content.push(t),this.sinkDown(this.content.length-1)},e.pop=function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.bubbleUp(0)),t},e.remove=function(t){var e=this.content.indexOf(t),r=this.content.pop();e!==this.content.length-1&&(this.content[e]=r,this.scoreFunction(r)<this.scoreFunction(t)?this.sinkDown(e):this.bubbleUp(e))},e.size=function(){return this.content.length},e.rescoreElement=function(t){this.sinkDown(this.content.indexOf(t))},e.sinkDown=function(t){for(var e=this.content[t];t>0;){var r=(t+1>>1)-1,n=this.content[r];if(!(this.scoreFunction(e)<this.scoreFunction(n)))break;this.content[r]=e,this.content[t]=n,t=r}},e.bubbleUp=function(t){for(var e=this.content.length,r=this.content[t],n=this.scoreFunction(r);;){var o=t+1<<1,i=o-1,s=null,a=void 0;if(i<e&&(a=this.scoreFunction(this.content[i]))<n&&(s=i),o<e&&this.scoreFunction(this.content[o])<(null===s?n:a)&&(s=o),null===s)break;this.content[t]=this.content[s],this.content[s]=r,t=s}},t}(),m=function(){function t(){}return t.init=function(t){for(var e=0;e<t.length;e++){var r=t[e];r.f=0,r.g=0,r.h=0,r.cost=1,r.visited=!1,r.closed=!1,r.parent=null}},t.cleanUp=function(t){for(var e=0;e<t.length;e++){var r=t[e];delete r.f,delete r.g,delete r.h,delete r.cost,delete r.visited,delete r.closed,delete r.parent}},t.heap=function(){return new y(function(t){return t.f})},t.search=function(t,e,r){this.init(t);var n=this.heap();for(n.push(e);n.size()>0;){var o=n.pop();if(o===r){for(var i=o,s=[];i.parent;)s.push(i),i=i.parent;return this.cleanUp(s),s.reverse()}o.closed=!0;for(var a=this.neighbours(t,o),u=0,h=a.length;u<h;u++){var c=a[u];if(!c.closed){var l=o.g+c.cost,p=c.visited;if(!p||l<c.g){if(c.visited=!0,c.parent=o,!c.centroid||!r.centroid)throw new Error("Unexpected state");c.h=c.h||this.heuristic(c.centroid,r.centroid),c.g=l,c.f=c.g+c.h,p?n.rescoreElement(c):n.push(c)}}}}return[]},t.heuristic=function(t,e){return b.distanceToSquared(t,e)},t.neighbours=function(t,e){for(var r=[],n=0;n<e.neighbours.length;n++)r.push(t[e.neighbours[n]]);return r},t}(),w=function(){function t(){}return t.buildZone=function(t,e){var n=this,o=this._buildNavigationMesh(t,e),i={};o.vertices.forEach(function(t){t.x=b.roundNumber(t.x,2),t.y=b.roundNumber(t.y,2),t.z=b.roundNumber(t.z,2)}),i.vertices=o.vertices;var s=this._buildPolygonGroups(o);return i.groups=new Array(s.length),s.forEach(function(t,e){var o=new Map;t.forEach(function(t,e){o.set(t,e)});var s=new Array(t.length);t.forEach(function(t,e){var a=[];t.neighbours.forEach(function(t){return a.push(o.get(t))});var u=[];t.neighbours.forEach(function(e){return u.push(n._getSharedVerticesInOrder(t,e))});var h=new r(0,0,0);h.add(i.vertices[t.vertexIds[0]]),h.add(i.vertices[t.vertexIds[1]]),h.add(i.vertices[t.vertexIds[2]]),h.divideScalar(3),h.x=b.roundNumber(h.x,2),h.y=b.roundNumber(h.y,2),h.z=b.roundNumber(h.z,2),s[e]={id:e,neighbours:a,vertexIds:t.vertexIds,centroid:h,portals:u}}),i.groups[e]=s}),i},t._buildNavigationMesh=function(t,e){return t=b.mergeVertices(t,e),this._buildPolygonsFromGeometry(t)},t._buildPolygonGroups=function(t){var e=[],r=function t(e){e.neighbours.forEach(function(r){void 0===r.group&&(r.group=e.group,t(r))})};return t.polygons.forEach(function(t){void 0!==t.group?e[t.group].push(t):(t.group=e.length,r(t),e.push([t]))}),e},t._buildPolygonNeighbours=function(t,e){var r=new Set,n=e[t.vertexIds[1]],o=e[t.vertexIds[2]];return e[t.vertexIds[0]].forEach(function(e){e!==t&&(n.includes(e)||o.includes(e))&&r.add(e)}),n.forEach(function(e){e!==t&&o.includes(e)&&r.add(e)}),r},t._buildPolygonsFromGeometry=function(t){for(var e=this,n=[],o=[],i=t.attributes.position,s=t.index,a=[],u=0;u<i.count;u++)o.push((new r).fromBufferAttribute(i,u)),a[u]=[];for(var h=0;h<t.index.count;h+=3){var c=s.getX(h),l=s.getX(h+1),p=s.getX(h+2),f={vertexIds:[c,l,p],neighbours:null};n.push(f),a[c].push(f),a[l].push(f),a[p].push(f)}return n.forEach(function(t){t.neighbours=e._buildPolygonNeighbours(t,a)}),{polygons:n,vertices:o}},t._getSharedVerticesInOrder=function(t,e){var r=t.vertexIds,n=r[0],o=r[1],i=r[2],s=e.vertexIds,a=s.includes(n),u=s.includes(o),h=s.includes(i);return a&&u&&h?Array.from(r):a&&u?[n,o]:u&&h?[o,i]:a&&h?[i,n]:(console.warn("Error processing navigation mesh neighbors; neighbors with <2 shared vertices found."),[])},t}(),x=function(){function t(){this.portals=[]}var e=t.prototype;return e.push=function(t,e){void 0===e&&(e=t),this.portals.push({left:t,right:e})},e.stringPull=function(){var t,e,r,n=this.portals,o=[],i=0,s=0,a=0;e=n[0].left,r=n[0].right,o.push(t=n[0].left);for(var u=1;u<n.length;u++){var h=n[u].left,c=n[u].right;if(b.triarea2(t,r,c)<=0){if(!(b.vequal(t,r)||b.triarea2(t,e,c)>0)){o.push(e),e=t=e,r=t,s=i=s,a=i,u=i;continue}r=c,a=u}if(b.triarea2(t,e,h)>=0){if(!(b.vequal(t,e)||b.triarea2(t,r,h)<0)){o.push(r),e=t=r,r=t,s=i=a,a=i,u=i;continue}e=h,s=u}}return 0!==o.length&&b.vequal(o[o.length-1],n[n.length-1].left)||o.push(n[n.length-1].left),this.path=o,o},t}(),_=function(){function t(){this.zones={}}t.createZone=function(t,e){return void 0===e&&(e=1e-4),w.buildZone(t,e)};var e=t.prototype;return e.setZoneData=function(t,e){this.zones[t]=e},e.getRandomNode=function(t,e,n,o){if(!this.zones[t])return new r;n=n||null,o=o||0;var i=[];return this.zones[t].groups[e].forEach(function(t){n&&o?b.distanceToSquared(n,t.centroid)<o*o&&i.push(t.centroid):i.push(t.centroid)}),b.sample(i)||new r},e.getClosestNode=function(t,e,r,n){void 0===n&&(n=!1);var o=this.zones[e].vertices,i=null,s=Infinity;return this.zones[e].groups[r].forEach(function(e){var r=b.distanceToSquared(e.centroid,t);r<s&&(!n||b.isVectorInPolygon(t,e,o))&&(i=e,s=r)}),i},e.findPath=function(t,e,n,o){var i=this.zones[n].groups[o],s=this.zones[n].vertices,a=this.getClosestNode(t,n,o,!0),u=this.getClosestNode(e,n,o,!0);if(!a||!u)return null;var h=m.search(i,a,u),c=function(t,e){for(var r=0;r<t.neighbours.length;r++)if(t.neighbours[r]===e.id)return t.portals[r]},l=new x;l.push(t);for(var p=0;p<h.length;p++){var f=h[p+1];if(f){var d=c(h[p],f);l.push(s[d[0]],s[d[1]])}}l.push(e),l.stringPull();var v=l.path.map(function(t){return new r(t.x,t.y,t.z)});return v.shift(),v},t}();_.prototype.getGroup=(g=new n,function(t,e,r){if(void 0===r&&(r=!1),!this.zones[t])return null;for(var n=null,o=Math.pow(50,2),i=this.zones[t],s=0;s<i.groups.length;s++)for(var a,u=v(i.groups[s]);!(a=u()).done;){var h=a.value;if(r&&(g.setFromCoplanarPoints(i.vertices[h.vertexIds[0]],i.vertices[h.vertexIds[1]],i.vertices[h.vertexIds[2]]),Math.abs(g.distanceToPoint(e))<.01&&b.isPointInPoly([i.vertices[h.vertexIds[0]],i.vertices[h.vertexIds[1]],i.vertices[h.vertexIds[2]]],e)))return s;var c=b.distanceToSquared(h.centroid,e);c<o&&(n=s,o=c)}return n}),_.prototype.clampStep=function(){var t,e,i=new r,s=new n,a=new o,u=new r,h=new r;return function(r,n,o,c,l,p){var f=this.zones[c].vertices,d=this.zones[c].groups[l],v=[o],g={};g[o.id]=0,t=void 0,h.set(0,0,0),e=Infinity,s.setFromCoplanarPoints(f[o.vertexIds[0]],f[o.vertexIds[1]],f[o.vertexIds[2]]),s.projectPoint(n,i),u.copy(i);for(var b=v.pop();b;b=v.pop()){a.set(f[b.vertexIds[0]],f[b.vertexIds[1]],f[b.vertexIds[2]]),a.closestPointToPoint(u,i),i.distanceToSquared(u)<e&&(t=b,h.copy(i),e=i.distanceToSquared(u));var y=g[b.id];if(!(y>2))for(var m=0;m<b.neighbours.length;m++){var w=d[b.neighbours[m]];w.id in g||(v.push(w),g[w.id]=y+1)}}return p.copy(h),t}}();var M={PLAYER:new i(15631215).convertGammaToLinear(2.2).getHex(),TARGET:new i(14469912).convertGammaToLinear(2.2).getHex(),PATH:new i(41903).convertGammaToLinear(2.2).getHex(),WAYPOINT:new i(41903).convertGammaToLinear(2.2).getHex(),CLAMPED_STEP:new i(14472114).convertGammaToLinear(2.2).getHex(),CLOSEST_NODE:new i(4417387).convertGammaToLinear(2.2).getHex()},P=function(r){var n,o;function i(){var t;return(t=r.call(this)||this)._playerMarker=new a(new u(.25,32,32),new h({color:M.PLAYER})),t._targetMarker=new a(new c(.3,.3,.3),new h({color:M.TARGET})),t._nodeMarker=new a(new c(.1,.8,.1),new h({color:M.CLOSEST_NODE})),t._stepMarker=new a(new c(.1,1,.1),new h({color:M.CLAMPED_STEP})),t._pathMarker=new l,t._pathLineMaterial=new p({color:M.PATH,linewidth:2}),t._pathPointMaterial=new h({color:M.WAYPOINT}),t._pathPointGeometry=new u(.08),t._markers=[t._playerMarker,t._targetMarker,t._nodeMarker,t._stepMarker,t._pathMarker],t._markers.forEach(function(e){e.visible=!1,t.add(e)}),t}o=r,(n=i).prototype=Object.create(o.prototype),n.prototype.constructor=n,f(n,o);var d=i.prototype;return d.setPath=function(r){for(;this._pathMarker.children.length;)this._pathMarker.children[0].visible=!1,this._pathMarker.remove(this._pathMarker.children[0]);r=[this._playerMarker.position].concat(r);var n=new e;n.setAttribute("position",new t(new Float32Array(3*r.length),3));for(var o=0;o<r.length;o++)n.attributes.position.setXYZ(o,r[o].x,r[o].y+.2,r[o].z);this._pathMarker.add(new s(n,this._pathLineMaterial));for(var i=0;i<r.length-1;i++){var u=new a(this._pathPointGeometry,this._pathPointMaterial);u.position.copy(r[i]),u.position.y+=.2,this._pathMarker.add(u)}return this._pathMarker.visible=!0,this},d.setPlayerPosition=function(t){return this._playerMarker.position.copy(t),this._playerMarker.visible=!0,this},d.setTargetPosition=function(t){return this._targetMarker.position.copy(t),this._targetMarker.visible=!0,this},d.setNodePosition=function(t){return this._nodeMarker.position.copy(t),this._nodeMarker.visible=!0,this},d.setStepPosition=function(t){return this._stepMarker.position.copy(t),this._stepMarker.visible=!0,this},d.reset=function(){for(;this._pathMarker.children.length;)this._pathMarker.children[0].visible=!1,this._pathMarker.remove(this._pathMarker.children[0]);return this._markers.forEach(function(t){t.visible=!1}),this},i}(l);export{_ as Pathfinding,P as PathfindingHelper};
//# sourceMappingURL=three-pathfinding.module.js.map
