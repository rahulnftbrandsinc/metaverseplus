{
  "{\"sourceRoot\":\"/Volumes/evo970/metahubs/scripts\",\"caller\":{\"name\":\"@babel/register\"},\"cwd\":\"/Volumes/evo970/metahubs\",\"filename\":\"/Volumes/evo970/metahubs/scripts/deploy.js\",\"babelrc\":false,\"configFile\":false,\"passPerPreset\":false,\"envName\":\"development\",\"root\":\"/Volumes/evo970/metahubs\",\"plugins\":[{\"key\":\"/Volumes/evo970/metahubs/node_modules/babel-plugin-react-intl/index.js\",\"visitor\":{\"Program\":{\"enter\":[null]},\"JSXOpeningElement\":{\"enter\":[null]},\"CallExpression\":{\"enter\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{}},{\"key\":\"/Volumes/evo970/metahubs/node_modules/babel-plugin-transform-react-jsx-img-import/lib/index.js\",\"visitor\":{\"CallExpression\":{\"enter\":[null]},\"Program\":{\"exit\":[null],\"enter\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{}},{\"key\":\"proposal-class-properties\",\"visitor\":{\"PrivateName\":{\"enter\":[null]},\"ExportDefaultDeclaration\":{\"enter\":[null]},\"_exploded\":true,\"_verified\":true,\"ClassDeclaration\":{\"enter\":[null]},\"ClassExpression\":{\"enter\":[null]}},\"options\":{\"loose\":true}},{\"key\":\"proposal-object-rest-spread\",\"visitor\":{\"_exploded\":{},\"_verified\":{},\"VariableDeclarator\":{\"enter\":[null]},\"ExportNamedDeclaration\":{\"enter\":[null]},\"CatchClause\":{\"enter\":[null]},\"AssignmentExpression\":{\"enter\":[null]},\"ObjectExpression\":{\"enter\":[null]},\"FunctionDeclaration\":{\"enter\":[null]},\"FunctionExpression\":{\"enter\":[null]},\"ObjectMethod\":{\"enter\":[null]},\"ArrowFunctionExpression\":{\"enter\":[null]},\"ClassMethod\":{\"enter\":[null]},\"ClassPrivateMethod\":{\"enter\":[null]},\"ForInStatement\":{\"enter\":[null]},\"ForOfStatement\":{\"enter\":[null]}},\"options\":{}},{\"key\":\"transform-async-to-generator\",\"visitor\":{\"_exploded\":true,\"_verified\":true,\"FunctionDeclaration\":{\"enter\":[null]},\"FunctionExpression\":{\"enter\":[null]},\"ObjectMethod\":{\"enter\":[null]},\"ArrowFunctionExpression\":{\"enter\":[null]},\"ClassMethod\":{\"enter\":[null]},\"ClassPrivateMethod\":{\"enter\":[null]}},\"options\":{}},{\"key\":\"proposal-optional-chaining\",\"visitor\":{\"_exploded\":{},\"_verified\":{},\"OptionalCallExpression\":{\"enter\":[null]},\"OptionalMemberExpression\":{\"enter\":[null]}},\"options\":{}},{\"key\":\"proposal-nullish-coalescing-operator\",\"visitor\":{\"_exploded\":{},\"_verified\":{},\"LogicalExpression\":{\"enter\":[null]}},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"proposal-optional-chaining\",\"visitor\":{\"_exploded\":{},\"_verified\":{},\"OptionalCallExpression\":{\"enter\":[null]},\"OptionalMemberExpression\":{\"enter\":[null]}},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"syntax-json-strings\",\"visitor\":{},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"syntax-optional-catch-binding\",\"visitor\":{},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"syntax-async-generators\",\"visitor\":{},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"syntax-object-rest-spread\",\"visitor\":{},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"transform-dotall-regex\",\"visitor\":{\"RegExpLiteral\":{\"enter\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"proposal-unicode-property-regex\",\"visitor\":{\"RegExpLiteral\":{\"enter\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"transform-named-capturing-groups-regex\",\"visitor\":{\"RegExpLiteral\":{\"enter\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"transform-template-literals\",\"visitor\":{\"TaggedTemplateExpression\":{\"enter\":[null]},\"TemplateLiteral\":{\"enter\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"transform-modules-commonjs\",\"visitor\":{\"CallExpression\":{\"enter\":[null]},\"Program\":{\"exit\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"proposal-dynamic-import\",\"visitor\":{\"_exploded\":{},\"_verified\":{},\"Program\":{\"enter\":[null]}},\"options\":{\"spec\":false,\"loose\":false,\"useBuiltIns\":false}},{\"key\":\"transform-react-jsx\",\"visitor\":{\"_exploded\":{},\"_verified\":{},\"JSXNamespacedName\":{\"enter\":[null]},\"JSXSpreadChild\":{\"enter\":[null]},\"JSXElement\":{\"exit\":[null]},\"JSXFragment\":{\"exit\":[null]},\"Program\":{\"enter\":[null],\"exit\":[null]},\"JSXAttribute\":{\"enter\":[null]}},\"options\":{\"pragma\":\"React.createElement\",\"pragmaFrag\":\"React.Fragment\",\"throwIfNamespace\":true,\"useBuiltIns\":false}},{\"key\":\"transform-react-display-name\",\"visitor\":{\"ExportDefaultDeclaration\":{\"enter\":[null]},\"CallExpression\":{\"enter\":[null]},\"_exploded\":true,\"_verified\":true},\"options\":{}}],\"presets\":[]}:7.3.3": {
    "metadata": {
      "react-intl": {
        "messages": [],
        "meta": {}
      }
    },
    "options": {
      "sourceRoot": "/Volumes/evo970/metahubs/scripts",
      "caller": {
        "name": "@babel/register"
      },
      "cwd": "/Volumes/evo970/metahubs",
      "filename": "/Volumes/evo970/metahubs/scripts/deploy.js",
      "babelrc": false,
      "configFile": false,
      "envName": "development",
      "root": "/Volumes/evo970/metahubs",
      "sourceMaps": "both",
      "ast": false,
      "passPerPreset": false,
      "plugins": [
        {
          "key": "/Volumes/evo970/metahubs/node_modules/babel-plugin-react-intl/index.js",
          "visitor": {
            "Program": {
              "enter": [
                null
              ]
            },
            "JSXOpeningElement": {
              "enter": [
                null
              ]
            },
            "CallExpression": {
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {}
        },
        {
          "key": "/Volumes/evo970/metahubs/node_modules/babel-plugin-transform-react-jsx-img-import/lib/index.js",
          "visitor": {
            "CallExpression": {
              "enter": [
                null
              ]
            },
            "Program": {
              "exit": [
                null
              ],
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {}
        },
        {
          "key": "proposal-class-properties",
          "visitor": {
            "PrivateName": {
              "enter": [
                null
              ]
            },
            "ExportDefaultDeclaration": {
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true,
            "ClassDeclaration": {
              "enter": [
                null
              ]
            },
            "ClassExpression": {
              "enter": [
                null
              ]
            }
          },
          "options": {
            "loose": true
          }
        },
        {
          "key": "proposal-object-rest-spread",
          "visitor": {
            "_exploded": {},
            "_verified": {},
            "VariableDeclarator": {
              "enter": [
                null
              ]
            },
            "ExportNamedDeclaration": {
              "enter": [
                null
              ]
            },
            "CatchClause": {
              "enter": [
                null
              ]
            },
            "AssignmentExpression": {
              "enter": [
                null
              ]
            },
            "ObjectExpression": {
              "enter": [
                null
              ]
            },
            "FunctionDeclaration": {
              "enter": [
                null
              ]
            },
            "FunctionExpression": {
              "enter": [
                null
              ]
            },
            "ObjectMethod": {
              "enter": [
                null
              ]
            },
            "ArrowFunctionExpression": {
              "enter": [
                null
              ]
            },
            "ClassMethod": {
              "enter": [
                null
              ]
            },
            "ClassPrivateMethod": {
              "enter": [
                null
              ]
            },
            "ForInStatement": {
              "enter": [
                null
              ]
            },
            "ForOfStatement": {
              "enter": [
                null
              ]
            }
          },
          "options": {}
        },
        {
          "key": "transform-async-to-generator",
          "visitor": {
            "_exploded": true,
            "_verified": true,
            "FunctionDeclaration": {
              "enter": [
                null
              ]
            },
            "FunctionExpression": {
              "enter": [
                null
              ]
            },
            "ObjectMethod": {
              "enter": [
                null
              ]
            },
            "ArrowFunctionExpression": {
              "enter": [
                null
              ]
            },
            "ClassMethod": {
              "enter": [
                null
              ]
            },
            "ClassPrivateMethod": {
              "enter": [
                null
              ]
            }
          },
          "options": {}
        },
        {
          "key": "proposal-optional-chaining",
          "visitor": {
            "_exploded": {},
            "_verified": {},
            "OptionalCallExpression": {
              "enter": [
                null
              ]
            },
            "OptionalMemberExpression": {
              "enter": [
                null
              ]
            }
          },
          "options": {}
        },
        {
          "key": "proposal-nullish-coalescing-operator",
          "visitor": {
            "_exploded": {},
            "_verified": {},
            "LogicalExpression": {
              "enter": [
                null
              ]
            }
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "proposal-optional-chaining",
          "visitor": {
            "_exploded": {},
            "_verified": {},
            "OptionalCallExpression": {
              "enter": [
                null
              ]
            },
            "OptionalMemberExpression": {
              "enter": [
                null
              ]
            }
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "syntax-json-strings",
          "visitor": {
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "syntax-optional-catch-binding",
          "visitor": {
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "syntax-async-generators",
          "visitor": {
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "syntax-object-rest-spread",
          "visitor": {
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "transform-dotall-regex",
          "visitor": {
            "RegExpLiteral": {
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "proposal-unicode-property-regex",
          "visitor": {
            "RegExpLiteral": {
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "transform-named-capturing-groups-regex",
          "visitor": {
            "RegExpLiteral": {
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "transform-template-literals",
          "visitor": {
            "TaggedTemplateExpression": {
              "enter": [
                null
              ]
            },
            "TemplateLiteral": {
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "transform-modules-commonjs",
          "visitor": {
            "CallExpression": {
              "enter": [
                null
              ]
            },
            "Program": {
              "exit": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "proposal-dynamic-import",
          "visitor": {
            "_exploded": {},
            "_verified": {},
            "Program": {
              "enter": [
                null
              ]
            }
          },
          "options": {
            "spec": false,
            "loose": false,
            "useBuiltIns": false
          }
        },
        {
          "key": "transform-react-jsx",
          "visitor": {
            "_exploded": {},
            "_verified": {},
            "JSXNamespacedName": {
              "enter": [
                null
              ]
            },
            "JSXSpreadChild": {
              "enter": [
                null
              ]
            },
            "JSXElement": {
              "exit": [
                null
              ]
            },
            "JSXFragment": {
              "exit": [
                null
              ]
            },
            "Program": {
              "enter": [
                null
              ],
              "exit": [
                null
              ]
            },
            "JSXAttribute": {
              "enter": [
                null
              ]
            }
          },
          "options": {
            "pragma": "React.createElement",
            "pragmaFrag": "React.Fragment",
            "throwIfNamespace": true,
            "useBuiltIns": false
          }
        },
        {
          "key": "transform-react-display-name",
          "visitor": {
            "ExportDefaultDeclaration": {
              "enter": [
                null
              ]
            },
            "CallExpression": {
              "enter": [
                null
              ]
            },
            "_exploded": true,
            "_verified": true
          },
          "options": {}
        }
      ],
      "presets": [],
      "parserOpts": {
        "sourceType": "module",
        "sourceFileName": "/Volumes/evo970/metahubs/scripts/deploy.js",
        "plugins": [
          "classProperties",
          "classPrivateProperties",
          "objectRestSpread",
          "optionalChaining",
          "nullishCoalescingOperator",
          "optionalChaining",
          "jsonStrings",
          "optionalCatchBinding",
          "asyncGenerators",
          "objectRestSpread",
          "dynamicImport",
          "jsx"
        ]
      },
      "generatorOpts": {
        "filename": "/Volumes/evo970/metahubs/scripts/deploy.js",
        "comments": true,
        "compact": "auto",
        "sourceMaps": "both",
        "sourceRoot": "/Volumes/evo970/metahubs/scripts",
        "sourceFileName": "deploy.js"
      }
    },
    "ast": null,
    "code": "\"use strict\";\n\nvar _fs = require(\"fs\");\n\nvar _child_process = require(\"child_process\");\n\nvar _rimraf = _interopRequireDefault(require(\"rimraf\"));\n\nvar _fsExtra = require(\"fs-extra\");\n\nvar _tar = _interopRequireDefault(require(\"tar\"));\n\nvar _ora = _interopRequireDefault(require(\"ora\"));\n\nvar _formData = _interopRequireDefault(require(\"form-data\"));\n\nvar _path = _interopRequireDefault(require(\"path\"));\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nfunction asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }\n\nfunction _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"next\", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, \"throw\", err); } _next(undefined); }); }; }\n\nif (!(0, _fs.existsSync)(\".ret.credentials\")) {\n  console.log(\"Not logged in, so cannot deploy. To log in, run npm run login.\");\n  process.exit(0);\n}\n\nconst {\n  host,\n  token\n} = JSON.parse((0, _fs.readFileSync)(\".ret.credentials\"));\nconsole.log(\"Deploying to \".concat(host, \".\"));\nconst step = (0, _ora.default)({\n  indent: 2\n}).start();\n\nconst getTs = (() => {\n  const p = n => n < 10 ? \"0\".concat(n) : n;\n\n  return () => {\n    const d = new Date();\n    return \"\".concat(d.getFullYear()).concat(p(d.getMonth() + 1)).concat(p(d.getDate())).concat(p(d.getHours())).concat(p(d.getMinutes())).concat(p(d.getSeconds()));\n  };\n})();\n\n_asyncToGenerator(function* () {\n  const headers = {\n    Authorization: \"Bearer \".concat(token),\n    \"Content-Type\": \"application/json\"\n  };\n  const res = yield fetch(\"https://\".concat(host, \"/api/ita/configs/hubs\"), {\n    headers\n  });\n  const hubsConfigs = yield res.json();\n  const buildEnv = {};\n\n  for (const [k, v] of Object.entries(hubsConfigs.general)) {\n    buildEnv[k.toUpperCase()] = v;\n  }\n\n  const version = getTs();\n  buildEnv.BUILD_VERSION = \"1.0.0.\".concat(version);\n  buildEnv.ITA_SERVER = \"\";\n  buildEnv.POSTGREST_SERVER = \"\";\n  buildEnv.CONFIGURABLE_SERVICES = \"janus-gateway,reticulum,hubs,spoke\";\n  const env = Object.assign(process.env, buildEnv);\n\n  for (const d of [\"./dist\", \"./admin/dist\"]) {\n    (0, _rimraf.default)(d, err => {\n      if (err) {\n        console.error(err);\n        process.exit(1);\n      }\n    });\n  }\n\n  step.text = \"Building Client.\";\n  yield new Promise((resolve, reject) => {\n    (0, _child_process.exec)(\"npm ci\", {}, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n  yield new Promise((resolve, reject) => {\n    (0, _child_process.exec)(\"npm run build\", {\n      env\n    }, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n  step.text = \"Building Admin Console.\";\n  yield new Promise((resolve, reject) => {\n    (0, _child_process.exec)(\"npm ci\", {\n      cwd: \"./admin\"\n    }, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n  yield new Promise((resolve, reject) => {\n    (0, _child_process.exec)(\"npm run build\", {\n      cwd: \"./admin\",\n      env\n    }, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n  yield new Promise(res => {\n    (0, _fsExtra.copy)(\"./admin/dist\", \"./dist\", err => {\n      if (err) {\n        console.error(err);\n        process.exit(1);\n      }\n\n      res();\n    });\n  });\n  step.text = \"Preparing Deploy.\";\n  step.text = \"Packaging Build.\";\n\n  _tar.default.c({\n    sync: true,\n    gzip: true,\n    C: _path.default.join(__dirname, \"..\", \"dist\"),\n    file: \"_build.tar.gz\"\n  }, [\".\"]);\n\n  step.text = \"Uploading Build \".concat(buildEnv.BUILD_VERSION, \".\");\n  let uploadedUrl;\n\n  const runUpload =\n  /*#__PURE__*/\n  function () {\n    var _ref2 = _asyncToGenerator(function* (attempt) {\n      if (attempt > 3) {\n        throw new Error(\"Upload failed.\");\n      }\n\n      const formData = new _formData.default();\n      formData.append(\"media\", (0, _fs.createReadStream)(\"_build.tar.gz\"));\n      formData.append(\"promotion_mode\", \"with_token\");\n\n      try {\n        const res = yield fetch(\"https://\".concat(host, \"/api/v1/media\"), {\n          method: \"POST\",\n          body: formData\n        });\n        const payload = yield res.json();\n        const url = new URL(payload.origin);\n        url.searchParams.set(\"token\", payload.meta.access_token);\n        uploadedUrl = url.toString();\n      } catch (e) {\n        step.text = \"Upload failed. Retrying attempt #\".concat(attempt + 1, \"/3\");\n        yield runUpload(attempt + 1);\n      }\n    });\n\n    return function runUpload(_x) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  yield runUpload(0);\n  (0, _fs.unlinkSync)(\"_build.tar.gz\");\n  step.text = \"Build uploaded, deploying.\"; // Wait for S3 flush, kind of a hack.\n\n  yield new Promise(res => setTimeout(res, 5000));\n  yield fetch(\"https://\".concat(host, \"/api/ita/deploy/hubs\"), {\n    headers,\n    method: \"POST\",\n    body: JSON.stringify({\n      url: uploadedUrl,\n      version\n    })\n  });\n  step.text = \"Deployed to \".concat(host, \".\");\n  step.succeed();\n  process.exit(0);\n})();\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRlcGxveS5qcyJdLCJuYW1lcyI6WyJjb25zb2xlIiwibG9nIiwicHJvY2VzcyIsImV4aXQiLCJob3N0IiwidG9rZW4iLCJKU09OIiwicGFyc2UiLCJzdGVwIiwiaW5kZW50Iiwic3RhcnQiLCJnZXRUcyIsInAiLCJuIiwiZCIsIkRhdGUiLCJnZXRGdWxsWWVhciIsImdldE1vbnRoIiwiZ2V0RGF0ZSIsImdldEhvdXJzIiwiZ2V0TWludXRlcyIsImdldFNlY29uZHMiLCJoZWFkZXJzIiwiQXV0aG9yaXphdGlvbiIsInJlcyIsImZldGNoIiwiaHVic0NvbmZpZ3MiLCJqc29uIiwiYnVpbGRFbnYiLCJrIiwidiIsIk9iamVjdCIsImVudHJpZXMiLCJnZW5lcmFsIiwidG9VcHBlckNhc2UiLCJ2ZXJzaW9uIiwiQlVJTERfVkVSU0lPTiIsIklUQV9TRVJWRVIiLCJQT1NUR1JFU1RfU0VSVkVSIiwiQ09ORklHVVJBQkxFX1NFUlZJQ0VTIiwiZW52IiwiYXNzaWduIiwiZXJyIiwiZXJyb3IiLCJ0ZXh0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJjd2QiLCJ0YXIiLCJjIiwic3luYyIsImd6aXAiLCJDIiwicGF0aCIsImpvaW4iLCJfX2Rpcm5hbWUiLCJmaWxlIiwidXBsb2FkZWRVcmwiLCJydW5VcGxvYWQiLCJhdHRlbXB0IiwiRXJyb3IiLCJmb3JtRGF0YSIsIkZvcm1EYXRhIiwiYXBwZW5kIiwibWV0aG9kIiwiYm9keSIsInBheWxvYWQiLCJ1cmwiLCJVUkwiLCJvcmlnaW4iLCJzZWFyY2hQYXJhbXMiLCJzZXQiLCJtZXRhIiwiYWNjZXNzX3Rva2VuIiwidG9TdHJpbmciLCJlIiwic2V0VGltZW91dCIsInN0cmluZ2lmeSIsInN1Y2NlZWQiXSwibWFwcGluZ3MiOiI7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7O0FBRUEsSUFBSSxDQUFDLG9CQUFXLGtCQUFYLENBQUwsRUFBcUM7QUFDbkNBLEVB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dEhEIiwic291cmNlUm9vdCI6Ii9Wb2x1bWVzL2V2bzk3MC9tZXRhaHVicy9zY3JpcHRzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlUmVhZFN0cmVhbSwgcmVhZEZpbGVTeW5jLCBleGlzdHNTeW5jLCB1bmxpbmtTeW5jIH0gZnJvbSBcImZzXCI7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCBybWRpciBmcm9tIFwicmltcmFmXCI7XG5pbXBvcnQgeyBjb3B5IH0gZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgdGFyIGZyb20gXCJ0YXJcIjtcbmltcG9ydCBvcmEgZnJvbSBcIm9yYVwiO1xuaW1wb3J0IEZvcm1EYXRhIGZyb20gXCJmb3JtLWRhdGFcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmlmICghZXhpc3RzU3luYyhcIi5yZXQuY3JlZGVudGlhbHNcIikpIHtcbiAgY29uc29sZS5sb2coXCJOb3QgbG9nZ2VkIGluLCBzbyBjYW5ub3QgZGVwbG95LiBUbyBsb2cgaW4sIHJ1biBucG0gcnVuIGxvZ2luLlwiKTtcbiAgcHJvY2Vzcy5leGl0KDApO1xufVxuXG5jb25zdCB7IGhvc3QsIHRva2VuIH0gPSBKU09OLnBhcnNlKHJlYWRGaWxlU3luYyhcIi5yZXQuY3JlZGVudGlhbHNcIikpO1xuY29uc29sZS5sb2coYERlcGxveWluZyB0byAke2hvc3R9LmApO1xuY29uc3Qgc3RlcCA9IG9yYSh7IGluZGVudDogMiB9KS5zdGFydCgpO1xuXG5jb25zdCBnZXRUcyA9ICgoKSA9PiB7XG4gIGNvbnN0IHAgPSBuID0+IChuIDwgMTAgPyBgMCR7bn1gIDogbik7XG4gIHJldHVybiAoKSA9PiB7XG4gICAgY29uc3QgZCA9IG5ldyBEYXRlKCk7XG4gICAgcmV0dXJuIGAke2QuZ2V0RnVsbFllYXIoKX0ke3AoZC5nZXRNb250aCgpICsgMSl9JHtwKGQuZ2V0RGF0ZSgpKX0ke3AoZC5nZXRIb3VycygpKX0ke3AoZC5nZXRNaW51dGVzKCkpfSR7cChcbiAgICAgIGQuZ2V0U2Vjb25kcygpXG4gICAgKX1gO1xuICB9O1xufSkoKTtcblxuKGFzeW5jICgpID0+IHtcbiAgY29uc3QgaGVhZGVycyA9IHtcbiAgICBBdXRob3JpemF0aW9uOiBgQmVhcmVyICR7dG9rZW59YCxcbiAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIlxuICB9O1xuXG4gIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGBodHRwczovLyR7aG9zdH0vYXBpL2l0YS9jb25maWdzL2h1YnNgLCB7IGhlYWRlcnMgfSk7XG4gIGNvbnN0IGh1YnNDb25maWdzID0gYXdhaXQgcmVzLmpzb24oKTtcbiAgY29uc3QgYnVpbGRFbnYgPSB7fTtcbiAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMoaHVic0NvbmZpZ3MuZ2VuZXJhbCkpIHtcbiAgICBidWlsZEVudltrLnRvVXBwZXJDYXNlKCldID0gdjtcbiAgfVxuXG4gIGNvbnN0IHZlcnNpb24gPSBnZXRUcygpO1xuXG4gIGJ1aWxkRW52LkJVSUxEX1ZFUlNJT04gPSBgMS4wLjAuJHt2ZXJzaW9ufWA7XG4gIGJ1aWxkRW52LklUQV9TRVJWRVIgPSBcIlwiO1xuICBidWlsZEVudi5QT1NUR1JFU1RfU0VSVkVSID0gXCJcIjtcbiAgYnVpbGRFbnYuQ09ORklHVVJBQkxFX1NFUlZJQ0VTID0gXCJqYW51cy1nYXRld2F5LHJldGljdWx1bSxodWJzLHNwb2tlXCI7XG5cbiAgY29uc3QgZW52ID0gT2JqZWN0LmFzc2lnbihwcm9jZXNzLmVudiwgYnVpbGRFbnYpO1xuXG4gIGZvciAoY29uc3QgZCBvZiBbXCIuL2Rpc3RcIiwgXCIuL2FkbWluL2Rpc3RcIl0pIHtcbiAgICBybWRpcihkLCBlcnIgPT4ge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHN0ZXAudGV4dCA9IFwiQnVpbGRpbmcgQ2xpZW50LlwiO1xuXG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBleGVjKFwibnBtIGNpXCIsIHt9LCBlcnIgPT4ge1xuICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBleGVjKFwibnBtIHJ1biBidWlsZFwiLCB7IGVudiB9LCBlcnIgPT4ge1xuICAgICAgaWYgKGVycikgcmVqZWN0KGVycik7XG4gICAgICByZXNvbHZlKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHN0ZXAudGV4dCA9IFwiQnVpbGRpbmcgQWRtaW4gQ29uc29sZS5cIjtcblxuICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZXhlYyhcIm5wbSBjaVwiLCB7IGN3ZDogXCIuL2FkbWluXCIgfSwgZXJyID0+IHtcbiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpO1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9KTtcblxuICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgZXhlYyhcIm5wbSBydW4gYnVpbGRcIiwgeyBjd2Q6IFwiLi9hZG1pblwiLCBlbnYgfSwgZXJyID0+IHtcbiAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpO1xuICAgICAgcmVzb2x2ZSgpO1xuICAgIH0pO1xuICB9KTtcblxuICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4ge1xuICAgIGNvcHkoXCIuL2FkbWluL2Rpc3RcIiwgXCIuL2Rpc3RcIiwgZXJyID0+IHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICBwcm9jZXNzLmV4aXQoMSk7XG4gICAgICB9XG4gICAgICByZXMoKTtcbiAgICB9KTtcbiAgfSk7XG4gIHN0ZXAudGV4dCA9IFwiUHJlcGFyaW5nIERlcGxveS5cIjtcblxuICBzdGVwLnRleHQgPSBcIlBhY2thZ2luZyBCdWlsZC5cIjtcbiAgdGFyLmMoeyBzeW5jOiB0cnVlLCBnemlwOiB0cnVlLCBDOiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uXCIsIFwiZGlzdFwiKSwgZmlsZTogXCJfYnVpbGQudGFyLmd6XCIgfSwgW1wiLlwiXSk7XG4gIHN0ZXAudGV4dCA9IGBVcGxvYWRpbmcgQnVpbGQgJHtidWlsZEVudi5CVUlMRF9WRVJTSU9OfS5gO1xuXG4gIGxldCB1cGxvYWRlZFVybDtcblxuICBjb25zdCBydW5VcGxvYWQgPSBhc3luYyBhdHRlbXB0ID0+IHtcbiAgICBpZiAoYXR0ZW1wdCA+IDMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlVwbG9hZCBmYWlsZWQuXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKFwibWVkaWFcIiwgY3JlYXRlUmVhZFN0cmVhbShcIl9idWlsZC50YXIuZ3pcIikpO1xuICAgIGZvcm1EYXRhLmFwcGVuZChcInByb21vdGlvbl9tb2RlXCIsIFwid2l0aF90b2tlblwiKTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly8ke2hvc3R9L2FwaS92MS9tZWRpYWAsIHsgbWV0aG9kOiBcIlBPU1RcIiwgYm9keTogZm9ybURhdGEgfSk7XG4gICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgcmVzLmpzb24oKTtcbiAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwocGF5bG9hZC5vcmlnaW4pO1xuICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoXCJ0b2tlblwiLCBwYXlsb2FkLm1ldGEuYWNjZXNzX3Rva2VuKTtcbiAgICAgIHVwbG9hZGVkVXJsID0gdXJsLnRvU3RyaW5nKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgc3RlcC50ZXh0ID0gYFVwbG9hZCBmYWlsZWQuIFJldHJ5aW5nIGF0dGVtcHQgIyR7YXR0ZW1wdCArIDF9LzNgO1xuICAgICAgYXdhaXQgcnVuVXBsb2FkKGF0dGVtcHQgKyAxKTtcbiAgICB9XG4gIH07XG5cbiAgYXdhaXQgcnVuVXBsb2FkKDApO1xuICB1bmxpbmtTeW5jKFwiX2J1aWxkLnRhci5nelwiKTtcblxuICBzdGVwLnRleHQgPSBcIkJ1aWxkIHVwbG9hZGVkLCBkZXBsb3lpbmcuXCI7XG5cbiAgLy8gV2FpdCBmb3IgUzMgZmx1c2gsIGtpbmQgb2YgYSBoYWNrLlxuICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDUwMDApKTtcblxuICBhd2FpdCBmZXRjaChgaHR0cHM6Ly8ke2hvc3R9L2FwaS9pdGEvZGVwbG95L2h1YnNgLCB7XG4gICAgaGVhZGVycyxcbiAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgdXJsOiB1cGxvYWRlZFVybCwgdmVyc2lvbiB9KVxuICB9KTtcblxuICBzdGVwLnRleHQgPSBgRGVwbG95ZWQgdG8gJHtob3N0fS5gO1xuICBzdGVwLnN1Y2NlZWQoKTtcbiAgcHJvY2Vzcy5leGl0KDApO1xufSkoKTtcbiJdfQ==",
    "map": {
      "version": 3,
      "sources": [
        "deploy.js"
      ],
      "names": [
        "console",
        "log",
        "process",
        "exit",
        "host",
        "token",
        "JSON",
        "parse",
        "step",
        "indent",
        "start",
        "getTs",
        "p",
        "n",
        "d",
        "Date",
        "getFullYear",
        "getMonth",
        "getDate",
        "getHours",
        "getMinutes",
        "getSeconds",
        "headers",
        "Authorization",
        "res",
        "fetch",
        "hubsConfigs",
        "json",
        "buildEnv",
        "k",
        "v",
        "Object",
        "entries",
        "general",
        "toUpperCase",
        "version",
        "BUILD_VERSION",
        "ITA_SERVER",
        "POSTGREST_SERVER",
        "CONFIGURABLE_SERVICES",
        "env",
        "assign",
        "err",
        "error",
        "text",
        "Promise",
        "resolve",
        "reject",
        "cwd",
        "tar",
        "c",
        "sync",
        "gzip",
        "C",
        "path",
        "join",
        "__dirname",
        "file",
        "uploadedUrl",
        "runUpload",
        "attempt",
        "Error",
        "formData",
        "FormData",
        "append",
        "method",
        "body",
        "payload",
        "url",
        "URL",
        "origin",
        "searchParams",
        "set",
        "meta",
        "access_token",
        "toString",
        "e",
        "setTimeout",
        "stringify",
        "succeed"
      ],
      "mappings": "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",
      "sourceRoot": "/Volumes/evo970/metahubs/scripts",
      "sourcesContent": [
        "import { createReadStream, readFileSync, existsSync, unlinkSync } from \"fs\";\nimport { exec } from \"child_process\";\nimport rmdir from \"rimraf\";\nimport { copy } from \"fs-extra\";\nimport tar from \"tar\";\nimport ora from \"ora\";\nimport FormData from \"form-data\";\nimport path from \"path\";\n\nif (!existsSync(\".ret.credentials\")) {\n  console.log(\"Not logged in, so cannot deploy. To log in, run npm run login.\");\n  process.exit(0);\n}\n\nconst { host, token } = JSON.parse(readFileSync(\".ret.credentials\"));\nconsole.log(`Deploying to ${host}.`);\nconst step = ora({ indent: 2 }).start();\n\nconst getTs = (() => {\n  const p = n => (n < 10 ? `0${n}` : n);\n  return () => {\n    const d = new Date();\n    return `${d.getFullYear()}${p(d.getMonth() + 1)}${p(d.getDate())}${p(d.getHours())}${p(d.getMinutes())}${p(\n      d.getSeconds()\n    )}`;\n  };\n})();\n\n(async () => {\n  const headers = {\n    Authorization: `Bearer ${token}`,\n    \"Content-Type\": \"application/json\"\n  };\n\n  const res = await fetch(`https://${host}/api/ita/configs/hubs`, { headers });\n  const hubsConfigs = await res.json();\n  const buildEnv = {};\n  for (const [k, v] of Object.entries(hubsConfigs.general)) {\n    buildEnv[k.toUpperCase()] = v;\n  }\n\n  const version = getTs();\n\n  buildEnv.BUILD_VERSION = `1.0.0.${version}`;\n  buildEnv.ITA_SERVER = \"\";\n  buildEnv.POSTGREST_SERVER = \"\";\n  buildEnv.CONFIGURABLE_SERVICES = \"janus-gateway,reticulum,hubs,spoke\";\n\n  const env = Object.assign(process.env, buildEnv);\n\n  for (const d of [\"./dist\", \"./admin/dist\"]) {\n    rmdir(d, err => {\n      if (err) {\n        console.error(err);\n        process.exit(1);\n      }\n    });\n  }\n\n  step.text = \"Building Client.\";\n\n  await new Promise((resolve, reject) => {\n    exec(\"npm ci\", {}, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n\n  await new Promise((resolve, reject) => {\n    exec(\"npm run build\", { env }, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n\n  step.text = \"Building Admin Console.\";\n\n  await new Promise((resolve, reject) => {\n    exec(\"npm ci\", { cwd: \"./admin\" }, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n\n  await new Promise((resolve, reject) => {\n    exec(\"npm run build\", { cwd: \"./admin\", env }, err => {\n      if (err) reject(err);\n      resolve();\n    });\n  });\n\n  await new Promise(res => {\n    copy(\"./admin/dist\", \"./dist\", err => {\n      if (err) {\n        console.error(err);\n        process.exit(1);\n      }\n      res();\n    });\n  });\n  step.text = \"Preparing Deploy.\";\n\n  step.text = \"Packaging Build.\";\n  tar.c({ sync: true, gzip: true, C: path.join(__dirname, \"..\", \"dist\"), file: \"_build.tar.gz\" }, [\".\"]);\n  step.text = `Uploading Build ${buildEnv.BUILD_VERSION}.`;\n\n  let uploadedUrl;\n\n  const runUpload = async attempt => {\n    if (attempt > 3) {\n      throw new Error(\"Upload failed.\");\n    }\n\n    const formData = new FormData();\n    formData.append(\"media\", createReadStream(\"_build.tar.gz\"));\n    formData.append(\"promotion_mode\", \"with_token\");\n\n    try {\n      const res = await fetch(`https://${host}/api/v1/media`, { method: \"POST\", body: formData });\n      const payload = await res.json();\n      const url = new URL(payload.origin);\n      url.searchParams.set(\"token\", payload.meta.access_token);\n      uploadedUrl = url.toString();\n    } catch (e) {\n      step.text = `Upload failed. Retrying attempt #${attempt + 1}/3`;\n      await runUpload(attempt + 1);\n    }\n  };\n\n  await runUpload(0);\n  unlinkSync(\"_build.tar.gz\");\n\n  step.text = \"Build uploaded, deploying.\";\n\n  // Wait for S3 flush, kind of a hack.\n  await new Promise(res => setTimeout(res, 5000));\n\n  await fetch(`https://${host}/api/ita/deploy/hubs`, {\n    headers,\n    method: \"POST\",\n    body: JSON.stringify({ url: uploadedUrl, version })\n  });\n\n  step.text = `Deployed to ${host}.`;\n  step.succeed();\n  process.exit(0);\n})();\n"
      ]
    },
    "sourceType": "script",
    "mtime": 1655192757000
  }
}